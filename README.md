# **Sorter**

Sorter is a python script that interacts with Splunk, it watches for new MISP data and sort by chosen conditions which data will be sent to Splunk.

It's based on the ZeroMQ client script available on the [Core MISP Project](https://github.com/MISP/MISP/blob/2.4/tools/misp-zmq/sub.py).

Using a YAML file, you can easily filter which kind of data will be sent to Splunk and in which mode, trigger an alert or just index data. Then you can create a search job to match collect data to your internal logs.

These are the available configuration fields:

## Configuration Fields

* **title**: Config file title
* **normalKey**: Splunk key used to send collected data from sorter to splunk
* **alertKey**: This key is intended to be different from normal key, sending data to another Splunk source, which can be configured to trigger an alert
* **trigger**: Accepts true or false. Every element that fit into sorter conditions, will be sent to the Splunk using alert key.
* **url**: Splunk url collector

## MISP Fields (These fields accept lists)

* **attributes**: The attribute types you will watch for
* **values**: Search for specific values inside of the attributes, that if found, will send an alert to Splunk. ex: *'yourOrgName'*
* **evtInfos**: Search for specific words in event infos, ex: *'OSINT'*
* **orgs**: Monitor for events generated by specific organisations
* **tags**: Search for specific tags in events

# Recommended Architecture

The recommended architecture to fully use of the script is to have a MISP instance syncronized to yours. More specifically, pushing data to your instance.
This allows to receive and handle data as soon as possible.
More information about how to syncronize instance [here](https://www.circl.lu/doc/misp/sharing/).

After that, enable [ZeroMQ Plugin](https://www.circl.lu/doc/misp/misp-zmq/).
Then just execute this script to listen on data generated by ZeroMQ Script server and send data to Splunk.

# How it works

It all begins on putting the attribute types under watch on the attributes field. If you dont want any alert, you **can repeat the normal key** on the alert key and you are ready to go!

You can search for specific values on attributes, attributes under watch will be sent to splunk anyway, but if an attribute value matches the searched one, it will be sent to the alert index.

The EvtInfos, Orgs and Tags works together, if you put any value on one of them, only attribute events that matches at least one of the conditions will be sent to Splunk, even if it matches the attribute type.

The trigger value is used to alert everything that matches the conditions. Only the alert key will be used. A good way to use that is to put some restrict conditions in the EvtInfos, Orgs and Tags and alert all of them.

# How to use (example)

Here's a basic example of a YAML config file that searches for *filename*, *link*, *hostname* and *domain* attributes.
It searches for values containing a organisation string name in case of a targeted threat and alerts matching cases

```YAML
title: 'General Configs'
attributes:
  - 'filename'
  - 'link'
  - 'hostname'
  - 'domain'
values: 'My organisation name'
evtInfos: 'OSINT'  
orgs:
tags:
normalKey: 'My Splunk Key'
alertKey: 'My Splunk Alert Key'
trigger: False
url: 'My Splunk URL'
```

# To Do
* Create Wiki explaining in more details the steps to use sorter and enable ZeroMQ Plugin in MISP;
* Evolve tag searches to handle taxonomy.
* Use virtual environment.

